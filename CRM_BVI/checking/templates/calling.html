{% extends "base_generic.html" %}

{% block title %}<title>Страница с поиском и фильтрами</title>{% endblock %}

{% block scripts %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/stylecalling.css' %}" crossorigin="anonymous"/>
     
    <script>
        function updateButtonText(dropdown, button, defaultText) {
            const items = dropdown.querySelectorAll('input[type="checkbox"]:checked');
            const values = Array.from(items).map(item => item.nextSibling.textContent.trim());
            button.textContent = values.join(', ') || defaultText;
        }

        function setButtonText(button, text) {
            button.textContent = text;
        }

        function toggleDropdown(dropdown) {
            if (dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            } else {
                dropdown.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Removed old status dropdown logic
            /*
            const statusDropdownItems = document.querySelectorAll('.comment-section .dropdown-content div');
            const statusButton = document.querySelector('.comment-section .dropdown button');
            statusDropdownItems.forEach(item => {
                item.addEventListener('click', () => {
                    setButtonText(statusButton, item.textContent.trim());
                });
            });
            */

            // Dropdown for status inside person-info section
            document.querySelectorAll('.comment-section').forEach(section => {
                const dropdown = section.querySelector('.dropdown');
                const statusButton = dropdown.querySelector('button');
                dropdown.querySelectorAll('.dropdown-content div').forEach(item => {
                    item.addEventListener('click', () => {
                        setButtonText(statusButton, item.textContent.trim());
                        dropdown.querySelector('.dropdown-content').style.display = 'none';
                    });
                });

                statusButton.addEventListener('click', () => {
                    toggleDropdown(dropdown.querySelector('.dropdown-content'));
                });
            });

            // Filters dropdowns
            const dropdownButtons = document.querySelectorAll('.filters .dropdown > button');
            dropdownButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const dropdownContent = button.nextElementSibling;
                    toggleDropdown(dropdownContent);
                });
            });

            // Close dropdowns if clicked outside
            window.addEventListener('click', (event) => {
                dropdownButtons.forEach(button => {
                    const dropdownContent = button.nextElementSibling;
                    if (!button.contains(event.target) && !dropdownContent.contains(event.target)) {
                        dropdownContent.style.display = 'none';
                    }
                });
            });

            // Initial update for buttons in filters
            document.querySelectorAll('.filters .dropdown').forEach(dropdown => {
                const button = dropdown.querySelector('button');
                const dropdownContent = dropdown.querySelector('.dropdown-content');
                const defaultText = button.textContent.trim();
                updateButtonText(dropdownContent, button, defaultText);
            });
        });
    </script>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('form').submit(function(event) {
        event.preventDefault();  // Предотвращаем стандартное действие формы
        var formData = $(this).serialize();  // Получаем данные формы
        $.post($(this).attr('action'), formData, function(response) {
            console.log('Comment saved successfully!');
            // Добавьте здесь код для обновления интерфейса, если нужно
        });
    });
});
</script>

<script>
    function handleAction(action, callID) {
        console.log("selected_action_" + callID);
        document.getElementById("selected_action_" + callID).value = action;
    }
</script>
{% endblock %}


{% block content %}
   <div class="main-content">
        <div class="search-box">
            <input type="text" placeholder="Поиск..." style="width: 80%; padding: 10px; font-size: 16px;">
        </div>
        <div class="filters">
            <div class="dropdown">
                <button>Статус ▼</button>
                <div class="dropdown-content">
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Статус ▼');"> Сомневается</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Статус ▼');"> Точно будет поступать</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Статус ▼');"> Ушел в другой ВУЗ</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Статус ▼');"> Нет информации</label>
                </div>
            </div>
            <div class="dropdown">
                <button>Институт ▼</button>
                <div class="dropdown-content">
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №1</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №2</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №3</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №4</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №5</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №6</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №7</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №8</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №9</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №10</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №11</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №12</label>
                    <label><input type="checkbox" onclick="updateButtonText(this.closest('.dropdown-content'), this.closest('.dropdown').querySelector('button'), 'Институт ▼');"> Институт №14</label>
                </div>
            </div>
        </div>
        {% if calling_list %}
      	{% for call in calling_list %}
        <div class="person-info">
            <div><strong>ФИО:</strong> {{call.last_name}} {{call.first_name}} {{call.middle_name}}</div>
            <div><strong>Дата рождения:</strong> {{call.birth_date}}</div>
            <div><strong>Телефон:</strong> {{call.phone_number}}</div>
            <div><strong>Email:</strong> {{call.email}}</div>
            <div><strong>Результаты ЕГЭ:</strong> Русский язык: {{call.ege_russian}}, Математика: {{call.ege_math}}, Физика: {{call.ege_physics}}, Информатика: {{call.ege_informatics}}</div>
            <div><strong>Олимпиады:</strong>
            {% for olim in call.olimpiads_set.all %}
            {{ olim.name }} | 
            {% endfor %}
            </div>
            <div class="comment-section">
                <form method="post" action="">
                {% csrf_token %}
                {% if call.call_result %}
                <textarea id="call_result" name="call_result" placeholder="Комментарий...">{{ call.call_result }}</textarea>
                {% else %}
                <textarea id="call_result" name="call_result" placeholder="Комментарий..."></textarea>
                {% endif %}
                <div class="dropdown">
                    <button id="{{ call.id }}">{{ call.status }} ▼</button>
                    <div id="myDropdown_{{ call_id }}" class="dropdown-content">
           		<div onclick="handleAction('Сомневается', {{ call.id }})">Сомневается</div>
          	  	<div onclick="handleAction('Точно будет поступать', {{ call.id }})">Точно будет поступать</div>
            		<div onclick="handleAction('Ушёл в другой ВУЗ', {{ call.id }})">Ушёл в другой ВУЗ</div>
            		<div onclick="handleAction('Нет информации', {{ call.id }})">Нет информации</div>
                    </div>
                </div>
                <input type="hidden" id="selected_action_{{ call.id }}" name="selected_action_{{ call.id }}" value="{{ call.status }}">
                <input type="hidden" id="call_id" name="call_id" value="{{ call.id }}"> 
                <button name="save" class="save-comment" type="submit">Сохранить комментарий</button>
                </form>
            </div>
        </div>
      {% endfor %}
    {% else %}
      <p>There are no abiturient in the SQL.</p>
    {% endif %}
    </div>
{% endblock %}

